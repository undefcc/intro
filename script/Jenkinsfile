// å®šä¹‰ç®¡é“å‚æ•°
properties([
    parameters([
        choice(
            name: 'DEPLOY_METHOD',
            choices: ['docker', 'pm2'],
            description: 'é€‰æ‹©éƒ¨ç½²æ–¹å¼',
            defaultValue: 'docker'
        ),
        string(
            name: 'APP_NAME',
            defaultValue: 'web-intro',
            description: 'åº”ç”¨åç§°'
        ),
        string(
            name: 'APP_VERSION',
            defaultValue: '',
            description: 'åº”ç”¨ç‰ˆæœ¬å·'
        ),
        string(
            name: 'GIT_BRANCH',
            defaultValue: 'main',
            description: 'Gitåˆ†æ”¯'
        )
    ])
])

// ç¯å¢ƒå˜é‡é…ç½®
def DOCKER_REGISTRY = "your-registry.com"  // ä½ çš„Dockerä»“åº“åœ°å€
def ECS_SERVER_IP = "47.115.57.172"          // ECSæœåŠ¡å™¨IP
def DEPLOY_PORT = "3000"                   // éƒ¨ç½²ç«¯å£
def REMOTE_DEPLOY_DIR = "/opt/apps"        // è¿œç¨‹éƒ¨ç½²ç›®å½•

pipeline {
    agent any
    stages {
        stage('åˆå§‹åŒ–') {
            steps {
                script {
                    // éªŒè¯å¿…è¦å‚æ•°
                    if (!params.APP_NAME) {
                        error "APP_NAME å‚æ•°ä¸èƒ½ä¸ºç©º"
                    }
                    if (!params.APP_VERSION) {
                        params.APP_VERSION = sh(
                            script: 'date +%Y%m%d%H%M%S',
                            returnStdout: true
                        ).trim()
                    }

                    echo "å¼€å§‹éƒ¨ç½²åº”ç”¨: ${params.APP_NAME}"
                    echo "ç‰ˆæœ¬: ${params.APP_VERSION}"
                    echo "éƒ¨ç½²æ–¹å¼: ${params.DEPLOY_METHOD}"
                    echo "ç›®æ ‡æœåŠ¡å™¨: ${ECS_SERVER_IP}"
                }
            }
        }

        stage('ä¸‹è½½æ„å»ºäº§ç‰©') {
            steps {
                script {
                    // è¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„å®é™…artifactå­˜å‚¨æ–¹å¼å®ç°ä¸‹è½½é€»è¾‘
                    // ç¤ºä¾‹ï¼šä»GitHub Actionsçš„artifactå­˜å‚¨ä¸‹è½½
                    def ARTIFACT_URL = "https://github.com/undefcc/intro/actions/artifacts/main"
                    def PACKAGE_NAME = "${params.APP_NAME}.tar.gz"

                    sh """
                        wget -q -O ${PACKAGE_NAME} "${ARTIFACT_URL}"
                        tar -xzf ${PACKAGE_NAME}
                        ls -la deployment/
                    """
                }
            }
        }
        stage('Dockeréƒ¨ç½²') {
            when {
                expression { params.DEPLOY_METHOD == 'docker' }
            }
            steps {
                script {
                    // æ„å»ºDockeré•œåƒ
                    sh """
                        docker build -t ${params.APP_NAME}:${params.APP_VERSION} .
                        docker tag ${params.APP_NAME}:${params.APP_VERSION} ${params.APP_NAME}:latest
                    """

                    // æ¨é€åˆ°Dockerä»“åº“ï¼ˆå¯é€‰ï¼‰
                    sh """
                        docker tag ${params.APP_NAME}:${params.APP_VERSION} ${DOCKER_REGISTRY}/${params.APP_NAME}:${params.APP_VERSION}
                        docker push ${DOCKER_REGISTRY}/${params.APP_NAME}:${params.APP_VERSION}
                    """

                    // éƒ¨ç½²åˆ°ECSæœåŠ¡å™¨
                    sshagent(['ecs-server-key']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ubuntu@${ECS_SERVER_IP} "
                                docker pull ${DOCKER_REGISTRY}/${params.APP_NAME}:${params.APP_VERSION} || true
                                docker stop ${params.APP_NAME} || true
                                docker rm ${params.APP_NAME} || true
                                docker run -d \
                                    -p ${DEPLOY_PORT}:3000 \
                                    --name ${params.APP_NAME} \
                                    --restart unless-stopped \
                                    ${params.APP_NAME}:${params.APP_VERSION}
                            "
                        """
                    }
                }
            }
        }

        stage('PM2éƒ¨ç½²') {
            when {
                expression { params.DEPLOY_METHOD == 'pm2' }
            }
            steps {
                script {
                    // é€šè¿‡SSHä¼ è¾“æ–‡ä»¶åˆ°ECSæœåŠ¡å™¨
                    sshagent(['ecs-server-key']) {
                        sh """
                            # åˆ›å»ºè¿œç¨‹ç›®å½•
                            ssh -o StrictHostKeyChecking=no ubuntu@${ECS_SERVER_IP} "
                                sudo mkdir -p ${REMOTE_DEPLOY_DIR}/${params.APP_NAME}
                                sudo chown -R ubuntu:ubuntu ${REMOTE_DEPLOY_DIR}
                            "

                            # ä¼ è¾“æ–‡ä»¶
                            scp -o StrictHostKeyChecking=no -r deployment/* ubuntu@${ECS_SERVER_IP}:${REMOTE_DEPLOY_DIR}/${params.APP_NAME}/

                            # éƒ¨ç½²åº”ç”¨
                            ssh -o StrictHostKeyChecking=no ubuntu@${ECS_SERVER_IP} "
                                cd ${REMOTE_DEPLOY_DIR}/${params.APP_NAME}
                                npm install --production
                                pm2 delete ${params.APP_NAME} || true
                                pm2 start ecosystem.config.js --name ${params.APP_NAME} --env production
                                pm2 save
                            "
                        """
                    }
                }
            }
        }
        stage('å¥åº·æ£€æŸ¥') {
            steps {
                script {
                    timeout(time: 2, unit: 'MINUTES') {
                        waitUntil {
                            try {
                                def response = sh(
                                    script: "curl -s -o /dev/null -w '%{http_code}' http://${ECS_SERVER_IP}:${DEPLOY_PORT}/api/health || echo '500'",
                                    returnStdout: true
                                ).trim()
                                echo "å¥åº·æ£€æŸ¥å“åº”: ${response}"
                                return response == "200"
                            } catch (Exception e) {
                                echo "å¥åº·æ£€æŸ¥å¤±è´¥: ${e.message}"
                                return false
                            }
                        }
                    }
                    echo "âœ… åº”ç”¨éƒ¨ç½²æˆåŠŸå¹¶é€šè¿‡å¥åº·æ£€æŸ¥"
                }
            }
        }
    }
    post {
        always {
            // æ¸…ç†å·¥ä½œ
            sh """
                docker system prune -f || true
                rm -rf deployment *.tar.gz || true
            """
            echo "æ„å»ºå®Œæˆ: ${currentBuild.result}"
        }
        success {
            echo "ğŸ‰ åº”ç”¨ ${params.APP_NAME} éƒ¨ç½²æˆåŠŸ!"
            // å¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œå¦‚Slackã€é‚®ä»¶ç­‰
        }
        failure {
            echo "âŒ åº”ç”¨ ${params.APP_NAME} éƒ¨ç½²å¤±è´¥!"
            // å¤±è´¥é€šçŸ¥
        }
    }
}